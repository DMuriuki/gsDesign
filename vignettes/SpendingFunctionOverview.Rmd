---
title: "Spending function overview"
output: rmarkdown::html_vignette
bibliography: gsDesign.bib
nocite: |
  @JTBook
vignette: >
  %\VignetteIndexEntry{Spending function overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "ragg_png",
  dpi = 96,
  fig.retina = 1,
  fig.width = 7.2916667,
  fig.align = "center",
  out.width = "80%"
)
```

# Introduction

Spending functions are used to set boundaries for group sequential designs.
Using the spending function approach to design offers a natural way to
provide interim testing boundaries when unplanned interim analyses are added
or when the timing of an interim analysis changes. Many standard and
investigational spending functions are provided in the gsDesign package.
These offer a great deal of flexibility in setting up stopping boundaries
for a design.

Spending functions have three arguments and return an object of type `spendfn`.
The `summary()` function for `spendfn` objects provides a brief
textual summary of a spending function or boundary used for a design.
Normally a spending function will be passed to `gsDesign()` in the parameter
`sfu` for the upper bound and `sfl` for the lower bound to specify a
spending function family for a design.
In this case, the user does not need to know the calling sequence ---
only how to specify the parameter(s) for the spending function. The calling
sequence is useful when the user wishes to plot a spending function as
demonstrated below in examples. In addition to using supplied spending
functions, a user can write code for a spending function. See examples.

For more details, see the
[spending functions](https://keaven.github.io/gsd-tech-manual/spendfn.html)
chapter in the gsDesign technical manual.

# Inputs

The three input arguments for spending functions are:

- `alpha`: Real value > 0 and no more than 1. Defaults in calls to
  `gsDesign()` are `alpha = 0.025` for one-sided Type I error
  specification and `alpha = 0.1` for Type II error specification.
  However, this could be set to 1 if, for descriptive purposes, you wish to
  see the proportion of spending as a function of the proportion of sample
  size/information.
- `t`: A vector of points with increasing values from 0 to 1, inclusive.
  Values of the proportion of sample size/information for which the spending
  function will be computed.
- `param`: A single real value or a vector of real values specifying the
  spending function parameter(s); this must be appropriately matched to the
  spending function specified.

# Outputs

Spending functions in general produce an object of type `spendfn`.
It contains the following components.

- `name`: A character string with the name of the spending function.
- `param`: Any parameters used for the spending function.
- `parname`: A character string or strings with the name(s) of the parameter(s)
  in `param`.
- `sf`: The spending function specified.
- `spend`: A vector of cumulative spending values corresponding to the
  input values in `t`.
- `bound`: This is null when returned from the spending function,
  but is set in `gsDesign()` if the spending function is called from there.
  Contains z-values for bounds of a design.
- `prob`: This is null when returned from the spending function,
  but is set in `gsDesign()` if the spending function is called from there.
  Contains probabilities of boundary crossing at $i$-th analysis for
  $j$-th theta value input to `gsDesign()` in `prob[i, j]`.

# Examples

```{r}
library(gsDesign)
```

## Using an implemented spending function

This simple example shows what most users need to know.
Assume we want to design a 4-analysis trial using a Hwang-Shih-DeCani
spending function for both lower and upper bounds.

```{r}
x <- gsDesign(k = 4, sfu = sfHSD, sfupar = -2, sfl = sfHSD, sflpar = 1)
```

Print the design:

```{r}
x
```

Summarize the spending functions:

```{r}
summary(x$upper)
summary(x$lower)
```

Plot the $\alpha$- and $\beta$-spending functions:

```{r, fig.asp=0.85}
plot(x, plottype = 5)
```

What happens to summary if we used a boundary function design:

```{r}
x <- gsDesign(test.type = 2, sfu = "OF")
y <- gsDesign(test.type = 1, sfu = "WT", sfupar = .25)
summary(x$upper)
summary(y$upper)
```

## Creating a new spending function

This advanced example shows how to write a new spending function.
Most users may ignore this.

Here, we implement a 2-parameter version of beta distribution spending function.
Assume the input arguments `t` and `alpha` are appropriately specified
(does not check for the sake of brevity).

```{r}
sfbdist <- function(alpha, t, param) {
  # Check inputs
  checkVector(param, "numeric", c(0, Inf), c(FALSE, TRUE))
  if (length(param) != 2) {
    stop("b-dist example spending function parameter must be of length 2")
  }

  # Set spending using cumulative beta distribution and return
  x <- list(
    name = "B-dist example",
    param = param,
    parname = c("a", "b"),
    sf = sfbdist,
    spend = alpha * pbeta(t, param[1], param[2]),
    bound = NULL,
    prob = NULL
  )
  class(x) <- "spendfn"

  x
}
```

Now try it out. Plot some example beta (lower bound) spending functions using
the beta distribution spending function.

```{r, fig.asp=1}
t <- 0:100 / 100
plot(t, sfbdist(1, t, c(2, 1))$spend,
  type = "l",
  xlab = "Proportion of information",
  ylab = "Cumulative proportion of total spending",
  main = "Beta distribution Spending Function Example"
)
lines(t, sfbdist(1, t, c(6, 4))$spend, lty = 2)
lines(t, sfbdist(1, t, c(.5, .5))$spend, lty = 3)
lines(t, sfbdist(1, t, c(.6, 2))$spend, lty = 4)
legend(
  x = c(.65, 1), y = 1 * c(0, .25), lty = 1:4,
  legend = c("a=2, b=1", "a=6, b=4", "a=0.5, b=0.5", "a=0.6, b=2")
)
```

# References
