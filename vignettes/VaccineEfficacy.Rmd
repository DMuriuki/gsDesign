---
title: "Vaccine Efficacy Trial Design"
output:
  html_document:
    code_folding: show
bibliography: gsDesign.bib
vignette: >
  %\VignetteIndexEntry{Vaccine Efficacy Trial Design}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

options(width = 58)
library(gsDesign)
library(gt)
library(dplyr)
```

# Introduction

This article/vignette provides an overview of functions considering designs for a vaccine efficacy study using the exact binomial method of @ChanBohidar.
It specifies spending function boundaries which are approximated for the exact binomial design by first computing a related time-to-event design.
The time-to-event design can not only be used to set boundaries for the @ChanBohidar method, but to allow specification of enrollment and study durations to determine enrollment rates and sample size required.

# Vaccine Efficacy

We begin by specifying parameters.
The `alpha` and `beta` parameters will not be met exactly due to the exact nature of the group sequential calculations performed.
Thus, you may need to adjust these parameters slightly to ensure your final design operating characteristics are within the targeted range.
All parameters here can be adjusted, but no other adjustments should be required.
The current version includes only designs that use non-binding futility bounds.
The design is generated by first using asymptotic theory for a time-to-event design with specified spending functions.
This design is then adapted to a design using the exact binomial method of @ChanBohidar.
The randomization ratio (experiemental/control) was assumed to be 3:1 as in the @SPUTNIK2021 trial.

```{r}
alpha <- 0.025 # Type I error
beta <- 0.1 # Type II error (1 - power)
k <- 3 # Number of analyses in group sequential design
timing <- c(.4, .7) # Relative timing of interim analyses compared to final
sfu <- sfLDOF # Efficacy bound spending function (O'Brien-Fleming-like here)
sfupar <- 0 # Parameter for efficacy spending function
sfl <- sfHSD # Futility bound spending function (Hwang-Shih-DeCani here)
sflpar <- -5 # Futility bound spending function parameter
timename <- "Month" # Time unit
failRate <- 0.002 # Exponential failure rate
dropoutRate <- .0001 # Exponential dropout rate
enrollDuration <- 3 # Enrollment duration
trialDuration <- 5 # Planned trial duration
VE1 <- .7 # Alternate hypothesis vaccine efficacy
VE0 <- .4 # Null hypothesis vaccine efficacy
ratio <- 3 # Experimental/Control enrollment ratio
```

Now we generate the design. If resulting alpha and beta do not satisfy requirements, adjust parameters above until a satisfactory result is obtained.
Press the code button below to review detailed code, which should not require user alteration.

```{r, class.source = 'fold-hide'}
# Derive Group Sequential Design
# This determines final sample size
x <- gsSurv(
  k = k, test.type = 4, alpha = alpha, beta = beta, timing = timing,
  sfu = sfu, sfupar = sfupar, sfl = sfl, sflpar = sflpar,
  lambdaC = failRate, eta = dropoutRate, hr = 1 - VE1, hr0 = 1 - VE0,
  R = enrollDuration, T = trialDuration,
  minfup = trialDuration - enrollDuration, ratio = ratio
)

# Translate vaccine efficacy to exact binomial probabilities

p0 <- (1 - VE0) * ratio / (1 + (1 - VE0) * ratio)
p1 <- (1 - VE1) * ratio / (1 + (1 - VE1) * ratio)

# Round up event counts and update spending based on slightly updated timing and then re-derive bounds.
# This will then be used to set event counts and bounds for the exact binomial bounds

counts <- ceiling(x$n.I)
timing <- counts / max(counts)
xx <- gsDesign(
  k = k, test.type = 4, timing = timing,
  alpha = alpha, beta = beta,
  sfu = sfu, sfupar = sfupar, sfl = sfl, sflpar = sflpar
)
zupper <- xx$upper$bound # Updated upper bounds
zlower <- xx$lower$bound # Updated lower bounds

# Invert the upper and lower bounds based on the inverse binomial distribution:

a <- qbinom(p = pnorm(-zupper), size = counts, prob = p0)
a[k] <- a[k] - 1
b <- qbinom(p = pnorm(zlower), size = counts, prob = p0, lower.tail = FALSE)
# a < b required for each analysis; subtracting 1 makes one bound or the other
# cross at the end
xxx <- gsBinomialExact(k = k, theta = c(p0, p1), n.I = counts, a = a, b = b)
```

```{r}
xxx
```

At this point, the upper bounds represent futility bounds and the lower bounds represent efficacy bound, so the labels above need to be fixed.
If the above design does not achieve the desired power, lower the `beta` parameter at the beginning of this document.
We compare the last line in the upper boundary table above by analysis to the targeted spending; values above should be similar to, but not the same as the targets below.

```{r}
xx$lower$spend
```

Following is a one-sided version to check non-binding Type I error.
If this is above desired level, reset `alpha` parameter to a smaller value.

```{r}
xnb <- gsBinomialExact(k = k, theta = c(p0, p1), n.I = counts, a = a, b = counts + 1)
xnb
```

Now we compare the spending above to that which was targeted.
This is compared to the next-to-last line in the above.

```{r}
xx$upper$spend
```

To understand the bounds, we note that at analysis 1, 15 or fewer of 39 events in the experimental group would reject the null hypothesis of $H_0:$ VE=`r VE0` in favor or $H_1:$ VE < `r VE0`.
On the other hand if 26 or more out of 39 events were in the experimental group, the trial could stop for futility.

The enrollment rate assumption is `r ceiling(x$gamma)` per `r timename` for `r enrollDuration` `r paste(timename,'s',sep="")` and the targeted duration of the trial to the final analysis is `r trialDuration` `r paste(timename,'s',sep="")`.

# References
